---
title: Celery í†ºì•„ë³´ê¸°
date: 2026-02-1 13:00:00 +09:00
categories: [python, celery]
tags:
  [
    python,
    celery,
    fastapi,
    redis,
  ]
---

Celery ê³µì‹ ë¬¸ì„œì—ì„œëŠ” Celeryë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.

> Celery is a simple, flexible, and reliable distributed system to process vast amounts of messages, while providing operations with the tools required to maintain such a system.

ì¦‰, CeleryëŠ” ëŒ€ëŸ‰ì˜ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ê°„ë‹¨í•˜ê³  ìœ ì—°í•˜ë©° ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë¶„ì‚° ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

Spring ìƒíƒœê³„ì—ì„œ RabbitMQ + `@Async` ë˜ëŠ” Kafkaë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹„ë™ê¸° ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì²˜ëŸ¼, Python ìƒíƒœê³„ì—ì„œëŠ” Celeryê°€ í‘œì¤€ì²˜ëŸ¼ ì‚¬ìš©ë©ë‹ˆë‹¤.

##  ğŸ³ ë¶„ì„ í™˜ê²½
- celery: 5.4.0
- python: 3.13
- redis: 7.x (ë¸Œë¡œì»¤/ë°±ì—”ë“œ)
- fastapi: 0.121.1

---

## âœ… Celeryì˜ í•µì‹¬ êµ¬ì„± ìš”ì†Œ

CeleryëŠ” í¬ê²Œ ë‹¤ì„¯ ê°€ì§€ í•µì‹¬ ì»´í¬ë„ŒíŠ¸ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚â”€â”€â”€â–¶â”‚   Broker    â”‚â”€â”€â”€â–¶â”‚   Worker    â”‚
â”‚ (Producer)  â”‚    â”‚  (Redis)    â”‚    â”‚ (Consumer)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                   â”‚   Backend   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚  (Redis)    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| ì»´í¬ë„ŒíŠ¸ | ì—­í•  | Spring ë¹„êµ |
|---------|------|-------------|
| **Client** | íƒœìŠ¤í¬ë¥¼ ìƒì„±í•˜ê³  ë¸Œë¡œì»¤ì— ë°œí–‰ | `RabbitTemplate.send()` |
| **Broker** | ë©”ì‹œì§€ í (Redis, RabbitMQ) | RabbitMQ, Kafka |
| **Worker** | íƒœìŠ¤í¬ë¥¼ consumeí•˜ê³  ì‹¤í–‰ | `@RabbitListener` |
| **Backend** | íƒœìŠ¤í¬ ê²°ê³¼ ì €ì¥ì†Œ | - |
| **Beat** | ìŠ¤ì¼€ì¤„ë§ (ì •ê¸° ì‹¤í–‰) | `@Scheduled` |

---

### ğŸ“Œ Celery ê¸°ë³¸ ì„¤ì •

Celery ì•±ì€ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•©ë‹ˆë‹¤.

```python
# worker/celery_app.py
from celery import Celery

app = Celery(
    "worker",
    broker="redis://localhost:6379/0",      # ë©”ì‹œì§€ ë¸Œë¡œì»¤
    backend="redis://localhost:6379/0",     # ê²°ê³¼ ì €ì¥ì†Œ
    include=["worker.tasks.basic"],         # íƒœìŠ¤í¬ ëª¨ë“ˆ
)

app.conf.update(
    task_serializer="json",
    accept_content=["json"],
    result_serializer="json",
    timezone="Asia/Seoul",
    enable_utc=True,
    task_track_started=True,
    task_time_limit=30 * 60,      # 30ë¶„ íƒ€ì„ì•„ì›ƒ
    result_expires=60 * 60,       # 1ì‹œê°„ í›„ ê²°ê³¼ ì‚­ì œ
)
```

**ì£¼ìš” ì„¤ì • ì˜µì…˜**

| ì˜µì…˜ | ì„¤ëª… |
|------|------|
| `broker` | ë©”ì‹œì§€ ë¸Œë¡œì»¤ URL |
| `backend` | ê²°ê³¼ ì €ì¥ì†Œ URL |
| `include` | ìë™ ë¡œë“œí•  íƒœìŠ¤í¬ ëª¨ë“ˆ |
| `task_serializer` | íƒœìŠ¤í¬ ì§ë ¬í™” ë°©ì‹ (json, pickle ë“±) |
| `task_time_limit` | íƒœìŠ¤í¬ ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ |
| `result_expires` | ê²°ê³¼ ë³´ê´€ ê¸°ê°„ |

<br>

---

## âœ… íƒœìŠ¤í¬ ì •ì˜

### 1ï¸âƒ£ ê¸°ë³¸ íƒœìŠ¤í¬

ê°€ì¥ ê°„ë‹¨í•œ íƒœìŠ¤í¬ ì •ì˜ ë°©ë²•ì…ë‹ˆë‹¤.

`ex) Springì˜ @Async ë©”ì„œë“œ ì—­í• `

```python
from worker.celery_app import app

@app.task
def add(x: int, y: int) -> int:
    """ë‘ ìˆ«ìë¥¼ ë”í•˜ëŠ” íƒœìŠ¤í¬"""
    return x + y

@app.task
def multiply(x: int, y: int) -> int:
    """ë‘ ìˆ«ìë¥¼ ê³±í•˜ëŠ” íƒœìŠ¤í¬"""
    return x * y
```

`@app.task` ë°ì½”ë ˆì´í„°ë¥¼ ë¶™ì´ë©´ í•´ë‹¹ í•¨ìˆ˜ê°€ Celery íƒœìŠ¤í¬ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.

<br>

### 2ï¸âƒ£ íƒœìŠ¤í¬ í˜¸ì¶œ ë°©ë²•

íƒœìŠ¤í¬ë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ë²•ì€ í¬ê²Œ ë‘ ê°€ì§€ì…ë‹ˆë‹¤.

**`.delay()` - ê°„ë‹¨í•œ í˜¸ì¶œ**
```python
# ë¹„ë™ê¸° í˜¸ì¶œ (ë¸Œë¡œì»¤ì— ë©”ì‹œì§€ ë°œí–‰)
result = add.delay(10, 20)

# task_id í™•ì¸
print(result.id)  # "abc-123-..."
```

**`.apply_async()` - ìƒì„¸ ì˜µì…˜ ì§€ì •**
```python
result = add.apply_async(
    args=[10, 20],
    countdown=5,              # 5ì´ˆ í›„ ì‹¤í–‰
    eta=datetime(2024, 1, 1), # íŠ¹ì • ì‹œê°„ì— ì‹¤í–‰
    expires=60,               # 60ì´ˆ í›„ ë§Œë£Œ
    queue="high_priority",    # íŠ¹ì • íë¡œ ë¼ìš°íŒ…
    retry=True,               # ì „ì†¡ ì‹¤íŒ¨ì‹œ ì¬ì‹œë„
)
```

| ë©”ì„œë“œ | íŠ¹ì§• | ì‚¬ìš© ì‹œì  |
|--------|------|----------|
| `.delay()` | ê°„í¸, ì˜µì…˜ ì—†ìŒ | ëŒ€ë¶€ë¶„ì˜ ê²½ìš° |
| `.apply_async()` | ìƒì„¸ ì˜µì…˜ ì§€ì • ê°€ëŠ¥ | ì§€ì—° ì‹¤í–‰, í ë¼ìš°íŒ… ë“± |

Springì—ì„œ `RabbitTemplate.convertAndSend()`ë¡œ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ëŠ” ê²ƒê³¼ ë™ì¼í•œ ê°œë…ì…ë‹ˆë‹¤.

<br>

### 3ï¸âƒ£ bind=Trueë¡œ íƒœìŠ¤í¬ ì •ë³´ ì ‘ê·¼

`bind=True` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ íƒœìŠ¤í¬ ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
from celery import Task

@app.task(bind=True)
def task_with_info(self: Task, message: str) -> dict:
    """íƒœìŠ¤í¬ ìì²´ ì •ë³´ì— ì ‘ê·¼í•˜ëŠ” ì˜ˆì œ"""
    return {
        "task_id": self.request.id,
        "task_name": self.name,
        "message": message,
        "retries": self.request.retries,
    }
```

`self.request`ë¥¼ í†µí•´ ì ‘ê·¼ ê°€ëŠ¥í•œ ì •ë³´:

| ì†ì„± | ì„¤ëª… |
|------|------|
| `self.request.id` | íƒœìŠ¤í¬ ID |
| `self.request.retries` | í˜„ì¬ ì¬ì‹œë„ íšŸìˆ˜ |
| `self.request.args` | ìœ„ì¹˜ ì¸ì |
| `self.request.kwargs` | í‚¤ì›Œë“œ ì¸ì |

<br>

### 4ï¸âƒ£ ì¬ì‹œë„ ë¡œì§

ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„í•˜ëŠ” íƒœìŠ¤í¬ë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`ex) Springì˜ @Retryable ì—­í• `

```python
@app.task(
    bind=True,
    max_retries=3,           # ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
    default_retry_delay=10,  # ì¬ì‹œë„ ê°„ê²© 10ì´ˆ
    autoretry_for=(Exception,),  # ìë™ ì¬ì‹œë„í•  ì˜ˆì™¸
)
def send_email(self, user_id: str, email: str) -> dict:
    """ì´ë©”ì¼ ë°œì†¡ (ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„)"""
    try:
        # ì™¸ë¶€ API í˜¸ì¶œ
        response = email_api.send(email)
        return {"status": "sent", "user_id": user_id}
    except EmailServerError as e:
        # ìˆ˜ë™ ì¬ì‹œë„ (ë” ì„¸ë°€í•œ ì œì–´)
        raise self.retry(exc=e, countdown=60)
```

**ì¬ì‹œë„ ì˜µì…˜**

| ì˜µì…˜ | ì„¤ëª… |
|------|------|
| `max_retries` | ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ |
| `default_retry_delay` | ê¸°ë³¸ ì¬ì‹œë„ ê°„ê²© (ì´ˆ) |
| `autoretry_for` | ìë™ ì¬ì‹œë„í•  ì˜ˆì™¸ í´ë˜ìŠ¤ë“¤ |
| `retry_backoff` | ì§€ìˆ˜ ë°±ì˜¤í”„ í™œì„±í™” |
| `retry_jitter` | ì¬ì‹œë„ ê°„ê²©ì— ëœë¤ì„± ì¶”ê°€ |

---

### ğŸ“Œ ê²°ê³¼ ì¡°íšŒ

íƒœìŠ¤í¬ ê²°ê³¼ëŠ” `AsyncResult`ë¥¼ í†µí•´ ì¡°íšŒí•©ë‹ˆë‹¤.

```python
from celery.result import AsyncResult

# íƒœìŠ¤í¬ í˜¸ì¶œ
result = add.delay(10, 20)
task_id = result.id

# ë‚˜ì¤‘ì— ê²°ê³¼ ì¡°íšŒ
async_result = AsyncResult(task_id)

# ìƒíƒœ í™•ì¸
print(async_result.status)  # PENDING, STARTED, SUCCESS, FAILURE

# ê²°ê³¼ í™•ì¸ (ì™„ë£Œëœ ê²½ìš°)
if async_result.ready():
    if async_result.successful():
        print(async_result.result)  # 30
    else:
        print(async_result.traceback)  # ì—ëŸ¬ ì •ë³´
```

**íƒœìŠ¤í¬ ìƒíƒœ**

| ìƒíƒœ | ì„¤ëª… |
|------|------|
| `PENDING` | ëŒ€ê¸° ì¤‘ (ë˜ëŠ” ì•Œ ìˆ˜ ì—†ìŒ) |
| `STARTED` | ì‹¤í–‰ ì¤‘ |
| `SUCCESS` | ì„±ê³µ |
| `FAILURE` | ì‹¤íŒ¨ |
| `RETRY` | ì¬ì‹œë„ ëŒ€ê¸° |
| `REVOKED` | ì·¨ì†Œë¨ |

<br>

### Fire & Forget íŒ¨í„´

ì‹¤ë¬´ì—ì„œëŠ” ëŒ€ë¶€ë¶„ ê²°ê³¼ë¥¼ ì¡°íšŒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```python
# ê²°ê³¼ ì•ˆ ê¸°ë‹¤ë¦¼, ì•ˆ í™•ì¸í•¨
send_welcome_email.delay(user_id, email)
return response  # ë°”ë¡œ ì‘ë‹µ
```

ì´ë¥¼ **Fire & Forget** íŒ¨í„´ì´ë¼ê³  í•©ë‹ˆë‹¤. ê²°ê³¼ê°€ ì„±ê³µì´ë“  ì‹¤íŒ¨ë“  í™•ì¸í•˜ì§€ ì•Šê³ , ì‹¤íŒ¨ ì‹œ Celeryì˜ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ê³¼ ëª¨ë‹ˆí„°ë§(Flower, Sentry)ì— ë§¡ê¹ë‹ˆë‹¤.

---

### ğŸ“Œ íƒœìŠ¤í¬ ì²´ì´ë‹

CeleryëŠ” ì—¬ëŸ¬ íƒœìŠ¤í¬ë¥¼ ì¡°í•©í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.

`ex) Springì˜ CompletableFuture.thenApply() ì²´ì´ë‹ ì—­í• `

### 1ï¸âƒ£ Chain - ìˆœì°¨ ì‹¤í–‰

ì´ì „ íƒœìŠ¤í¬ì˜ ê²°ê³¼ê°€ ë‹¤ìŒ íƒœìŠ¤í¬ì˜ ì…ë ¥ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.

```python
from celery import chain

# step1 â†’ step2 â†’ step3 ìˆœì°¨ ì‹¤í–‰
task_chain = chain(
    step1.s("data"),  # s()ëŠ” signatureì˜ ì•½ì
    step2.s(),
    step3.s(),
)
result = task_chain.apply_async()
```

```
step1("data") â†’ "[step1:data]"
                      â†“
step2("[step1:data]") â†’ "[step2:[step1:data]]"
                              â†“
step3("[step2:[step1:data]]") â†’ ìµœì¢… ê²°ê³¼
```

<br>

### 2ï¸âƒ£ Group - ë³‘ë ¬ ì‹¤í–‰

ì—¬ëŸ¬ íƒœìŠ¤í¬ë¥¼ ë™ì‹œì— ì‹¤í–‰í•©ë‹ˆë‹¤.

```python
from celery import group

# ë³‘ë ¬ ì‹¤í–‰
task_group = group(
    add.s(1, 2),
    add.s(3, 4),
    multiply.s(5, 6),
)
result = task_group.apply_async()

# ê²°ê³¼: [3, 7, 30]
```

<br>

### 3ï¸âƒ£ Chord - ë³‘ë ¬ ì‹¤í–‰ í›„ ì½œë°±

ë³‘ë ¬ ì‹¤í–‰ ê²°ê³¼ë¥¼ ëª¨ì•„ì„œ ì½œë°± íƒœìŠ¤í¬ì— ì „ë‹¬í•©ë‹ˆë‹¤.

```python
from celery import chord

@app.task
def sum_results(results: list[int]) -> int:
    return sum(results)

# (1+2) + (3+4) + (5+6) = 21
task_chord = chord(
    [add.s(1, 2), add.s(3, 4), add.s(5, 6)],  # ë³‘ë ¬ ì‹¤í–‰
    sum_results.s()  # ì½œë°±
)
result = task_chord.apply_async()
```

---

## âœ… Beat - ìŠ¤ì¼€ì¤„ë§

ì •ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” íƒœìŠ¤í¬ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`ex) Springì˜ @Scheduled ì—­í• `

```python
from celery.schedules import crontab

app.conf.beat_schedule = {
    # ë§¤ ë¶„ë§ˆë‹¤ ì‹¤í–‰
    "heartbeat-every-minute": {
        "task": "worker.tasks.basic.heartbeat",
        "schedule": 60.0,  # 60ì´ˆë§ˆë‹¤
    },
    # ë§¤ì¼ ìì •ì— ì‹¤í–‰
    "daily-report": {
        "task": "worker.tasks.basic.daily_report",
        "schedule": crontab(hour=0, minute=0),
    },
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ
    "weekly-summary": {
        "task": "worker.tasks.basic.weekly_summary",
        "schedule": crontab(hour=9, minute=0, day_of_week=1),
    },
}
```

**crontab í‘œí˜„ì‹**

| í‘œí˜„ì‹ | ì„¤ëª… |
|--------|------|
| `crontab()` | ë§¤ ë¶„ |
| `crontab(minute=0, hour=0)` | ë§¤ì¼ ìì • |
| `crontab(minute=0, hour='*/3')` | 3ì‹œê°„ë§ˆë‹¤ |
| `crontab(day_of_week='mon')` | ë§¤ì£¼ ì›”ìš”ì¼ |

Beat ì‹¤í–‰:
```bash
celery -A worker.celery_app beat --loglevel=info
```

---

## âœ… ì‹¤ë¬´ ì ìš© íŒ¨í„´

### ì–´ë–¤ ì‘ì—…ì„ Celeryì— ìœ„ì„í• ê¹Œ?

| ìœ„ì„ O | ìœ„ì„ X |
|--------|--------|
| ì´ë©”ì¼/SMS ë°œì†¡ | ì¦‰ì‹œ ì‘ë‹µ í•„ìš”í•œ ì¡°íšŒ |
| ì™¸ë¶€ API í˜¸ì¶œ | ê°€ë²¼ìš´ DB ì‘ì—… |
| ë¦¬í¬íŠ¸ ìƒì„± | ë¹ ë¥¸ ê³„ì‚° |
| ì´ë¯¸ì§€ ì²˜ë¦¬ | ì¦‰ì‹œì„± í•„ìš”í•œ ì¸ì¦ |
| ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ í•„ìš” | ë™ê¸°ì  íë¦„ í•„ìš” |

<br>

### ì‹¤ë¬´ êµ¬ì¡° ì˜ˆì‹œ

```python
# router.py
@router.post("/users/signup")
async def signup(request: SignupRequest):
    return await user_service.signup(request)

# service.py
class UserService:
    async def signup(self, request: SignupRequest):
        # 1. ìœ ì € ìƒì„± (ë™ê¸°)
        user = await self.repository.save(...)

        # 2. ì¦‰ì‹œì„± í•„ìš”í•œ ì‘ì—… (ë™ê¸°)
        await self._send_verification_sms(user.phone, code)

        # 3. Celery ìœ„ì„ (ë¹„ë™ê¸° - Fire & Forget)
        send_welcome_email.delay(user.id, user.email)
        notify_admin_new_signup.delay(user.id)

        return response
```

**íŒë‹¨ ê¸°ì¤€:**
- **ì¦‰ì‹œì„± í•„ìš”** â†’ ë™ê¸° ì²˜ë¦¬
- **ì²˜ë¦¬ ë³´ì¥/ì¬ì‹œë„ í•„ìš”** â†’ Celery ìœ„ì„
- **ì™¸ë¶€ API, ëŠë¦° ì‘ì—…** â†’ Celery ìœ„ì„
- **ìœ ì € ì‘ë‹µê³¼ ë¬´ê´€** â†’ Celery ìœ„ì„

---

### ğŸ“Œ Redis vs RabbitMQ

| í•­ëª© | Redis | RabbitMQ |
|------|-------|----------|
| ì„¤ì¹˜/ìš´ì˜ | ê°„ë‹¨ | ë³µì¡ |
| ì„±ëŠ¥ | ë¹ ë¦„ | ìƒëŒ€ì ìœ¼ë¡œ ëŠë¦¼ |
| ë©”ì‹œì§€ ì˜ì†ì„± | ê¸°ë³¸ ë©”ëª¨ë¦¬ | ë””ìŠ¤í¬ ì €ì¥ |
| DLQ (Dead Letter Queue) | ì—†ìŒ | ë„¤ì´í‹°ë¸Œ ì§€ì› |
| ë¼ìš°íŒ… | ë‹¨ìˆœ | Exchange/Binding |
| ì‚¬ìš©ì²˜ | ê°„ë‹¨í•œ ë¹„ë™ê¸° | ë©”ì‹œì§€ ë³´ì¥ ì¤‘ìš” |

**ê²°ë¡ :**
- ê°„ë‹¨í•œ ë¹„ë™ê¸° ì‘ì—… â†’ **Redis**
- ë©”ì‹œì§€ ìœ ì‹¤ ë°©ì§€ ì¤‘ìš” â†’ **RabbitMQ**
- Celery ì½”ë“œëŠ” ë™ì¼, ë¸Œë¡œì»¤ë§Œ ë³€ê²½í•˜ë©´ ë¨

---

## âœ… ì›Œì»¤ ì‹¤í–‰

```bash
# ì›Œì»¤ ì‹œì‘
celery -A worker.celery_app worker --loglevel=info

# ë™ì‹œì„± ì„¤ì •
celery -A worker.celery_app worker --concurrency=4

# íŠ¹ì • íë§Œ ì²˜ë¦¬
celery -A worker.celery_app worker -Q high_priority,default
```

**ì£¼ìš” ì˜µì…˜**

| ì˜µì…˜ | ì„¤ëª… |
|------|------|
| `--concurrency` | ë™ì‹œ ì²˜ë¦¬ ì›Œì»¤ ìˆ˜ |
| `-Q` | ì²˜ë¦¬í•  í ì§€ì • |
| `--loglevel` | ë¡œê·¸ ë ˆë²¨ |
| `--autoscale=10,3` | ìë™ ìŠ¤ì¼€ì¼ë§ (ìµœëŒ€ 10, ìµœì†Œ 3) |

<br>

### ë™ì‹œì„±(Concurrency)ê³¼ Pool

`--concurrency=4`ëŠ” ë™ì‹œì— ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” íƒœìŠ¤í¬ ìˆ˜ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ê¸°ë³¸ì€ **ë©€í‹° í”„ë¡œì„¸ìŠ¤(prefork)** ë°©ì‹ì…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Main Process                    â”‚
â”‚               (Worker Controller)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚         â”‚         â”‚         â”‚
          â–¼         â–¼         â–¼         â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Child  â”‚ â”‚ Child  â”‚ â”‚ Child  â”‚ â”‚ Child  â”‚
     â”‚ Proc 1 â”‚ â”‚ Proc 2 â”‚ â”‚ Proc 3 â”‚ â”‚ Proc 4 â”‚
     â”‚ Task A â”‚ â”‚ Task B â”‚ â”‚ Task C â”‚ â”‚ (idle) â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Pool ì¢…ë¥˜**

```bash
# ë©€í‹° í”„ë¡œì„¸ìŠ¤ (ê¸°ë³¸ê°’)
celery -A app worker --pool=prefork --concurrency=4

# ë©€í‹° ìŠ¤ë ˆë“œ
celery -A app worker --pool=threads --concurrency=4

# ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë£¨í”„ (gevent/eventlet)
celery -A app worker --pool=gevent --concurrency=100
```

| Pool | ë™ì‘ ë°©ì‹ | ì í•©í•œ ì‘ì—… | Spring ë¹„êµ |
|------|----------|------------|-------------|
| `prefork` | ë©€í‹° í”„ë¡œì„¸ìŠ¤ | CPU ë°”ìš´ë“œ (ê³„ì‚°, ì´ë¯¸ì§€ ì²˜ë¦¬) | ProcessPoolExecutor |
| `threads` | ë©€í‹° ìŠ¤ë ˆë“œ | I/O ë°”ìš´ë“œ (ê°€ë²¼ìš´ API í˜¸ì¶œ) | ThreadPoolExecutor (`@Async`) |
| `gevent` | ì½”ë£¨í‹´ (greenlet) | I/O ë°”ìš´ë“œ (ëŒ€ëŸ‰ ë„¤íŠ¸ì›Œí¬ ìš”ì²­) | WebFlux (ë¦¬ì•¡í‹°ë¸Œ) |
| `eventlet` | ì½”ë£¨í‹´ | geventì™€ ìœ ì‚¬ | - |
| `solo` | ë‹¨ì¼ ìŠ¤ë ˆë“œ | ë””ë²„ê¹…ìš© | - |

**ì‹¤ë¬´ ì„ íƒ ê¸°ì¤€**

| ìƒí™© | ì¶”ì²œ Pool | concurrency |
|------|----------|-------------|
| ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§•, PDF ìƒì„± | prefork | CPU ì½”ì–´ ìˆ˜ |
| ì´ë©”ì¼/SMS ë°œì†¡ | gevent | 100~1000 |
| ì™¸ë¶€ API ëŒ€ëŸ‰ í˜¸ì¶œ | gevent | 100~500 |
| ì¼ë°˜ì ì¸ í˜¼í•© ì‘ì—… | prefork | ì½”ì–´ ìˆ˜ * 2 |

<br>

### íƒœìŠ¤í¬ë³„ íƒ€ì„ì•„ì›ƒ ì„¤ì •

ì „ì—­ ì„¤ì • ì™¸ì— íƒœìŠ¤í¬ë³„ë¡œ ê°œë³„ íƒ€ì„ì•„ì›ƒì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
# ì „ì—­ ì„¤ì • (ê¸°ë³¸ê°’)
app.conf.update(
    task_time_limit=30 * 60,  # 30ë¶„
)

# íƒœìŠ¤í¬ë³„ ê°œë³„ ì„¤ì •
@app.task(time_limit=3600)  # 1ì‹œê°„
def long_batch_job():
    ...

@app.task(time_limit=7200)  # 2ì‹œê°„
def super_long_report():
    ...
```

**soft_time_limit vs time_limit**

| ì˜µì…˜ | ë™ì‘ |
|------|------|
| `soft_time_limit` | ì‹œê°„ ì´ˆê³¼ ì‹œ `SoftTimeLimitExceeded` ì˜ˆì™¸ ë°œìƒ (ì •ë¦¬ ê°€ëŠ¥) |
| `time_limit` | ì‹œê°„ ì´ˆê³¼ ì‹œ ê°•ì œ ì¢…ë£Œ (SIGKILL) |

```python
from celery.exceptions import SoftTimeLimitExceeded

@app.task(soft_time_limit=3500, time_limit=3600)
def batch_job():
    try:
        # ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…
        ...
    except SoftTimeLimitExceeded:
        # soft limit ë„ë‹¬ - ì •ë¦¬ ì‘ì—… ìˆ˜í–‰
        save_progress()
        cleanup()
        raise
```

ì‹¤ë¬´ì—ì„œëŠ” `soft_time_limit`ìœ¼ë¡œ ë¨¼ì € ê²½ê³ ë°›ì•„ ì •ë¦¬í•  ì‹œê°„ì„ í™•ë³´í•˜ê³ , `time_limit`ìœ¼ë¡œ ìµœì¢… ê°•ì œ ì¢…ë£Œí•˜ëŠ” íŒ¨í„´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

---

### ğŸ“Œ ëª¨ë‹ˆí„°ë§ - Flower

Celery ì „ìš© ì›¹ ëª¨ë‹ˆí„°ë§ ë„êµ¬ì…ë‹ˆë‹¤.

```bash
pip install flower
celery -A worker.celery_app flower --port=5555
```

`http://localhost:5555`ì—ì„œ:
- ì‹¤ì‹œê°„ íƒœìŠ¤í¬ ìƒíƒœ í™•ì¸
- ì›Œì»¤ ìƒíƒœ ëª¨ë‹ˆí„°ë§
- íƒœìŠ¤í¬ ì„±ê³µ/ì‹¤íŒ¨ í†µê³„
- íƒœìŠ¤í¬ ì·¨ì†Œ(revoke)
- ì„ì‹œë¡œ ì‚¬ìš©ì€ ê´œì°®ìœ¼ë‚˜ ê°€ë…ì„±ì´ ì•ˆì¢‹ì€ ê´€ê³„ë¡œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ë§¤íŠ¸ë¦­ì„ ë³„ë„ë¡œ ìˆ˜ì§‘í•˜ì—¬ ëª¨ë‹ˆí„°ë§ì„ í•˜ëŠ”ê²ƒì„ ê¶Œì¥

---

## âœ… ë§ˆì¹˜ë©°

- ì´ì²˜ëŸ¼ CeleryëŠ” Python ìƒíƒœê³„ì—ì„œ ë¹„ë™ê¸° ì‘ì—… ì²˜ë¦¬ì˜ í‘œì¤€ìœ¼ë¡œ, Springì˜ `@Async` + RabbitMQ ì¡°í•©ê³¼ ìœ ì‚¬í•œ ì—­í• ì„ í•©ë‹ˆë‹¤. ê°„ë‹¨í•œ ì„¤ì •ìœ¼ë¡œ ê°•ë ¥í•œ ë¶„ì‚° íƒœìŠ¤í¬ ì²˜ë¦¬ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ ê°€ì¥ í° ì¥ì ì…ë‹ˆë‹¤.
- ê·¸ëƒ¥ ë‹¨ìˆœíˆ MQ ì¶”ìƒí™”  + Retry + Schedulingì˜ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¼ê³  ìƒê°í•˜ë©´ ë‹¨ìˆœí•  ê²ƒ ê°™ë‹¤.
- Spring Batch ì²˜ëŸ¼ ë³µì¡í•œ Step êµ¬ì¡°ëŠ” ì§€ì›í•´ì£¼ì§„ ì•Šì§€ë§Œ, ë°°ì¹˜ì„± ì‘ì—…ì„ êµ¬í˜„í•˜ëŠ”ë°ì—ëŠ” ì¶©ë¶„í•  ê²ƒ ê°™ë‹¤.
- ì²˜ë¦¬ë³´ì¥ì´ í•„ìš”í•œ ì‘ì—…ì´ë‚˜, ë¹„ë™ê¸° ë¡œì§ì´ í•„ìš”í•  ê²½ìš° celeryë¥¼ ì´ìš©í•˜ì—¬ EDDë¥¼ êµ¬í˜„í•˜ëŠ”ê²ƒë„ ì¢‹ì€ ë°©ë²•ì¼ ê²ƒ ê°™ë‹¤.
