---
title: ë™ì„œì‹± ì´ìŠˆ í•´ê²° ë°©ë²•
date: 2024-03-19 23:30:00 +09:00
categories: [spring]
tags:
  [
    java,
    íŠ¸ëœì­ì…˜,
    synchronized,
    Spring,
    redis,
    docker
  ]
---

* * *

í•´ë‹¹ ê¸€ì€ [ì¬ê³ ì‹œìŠ¤í…œìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë™ì‹œì„± ì´ìŠˆ í•´ê²° ë°©ë²•](https://www.inflearn.com/course/%EB%8F%99%EC%8B%9C%EC%84%B1%EC%9D%B4%EC%8A%88-%EC%9E%AC%EA%B3%A0%EC%8B%9C%EC%8A%A4%ED%85%9C/dashboard) ê°•ì˜ë¥¼ ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤.

`ì •ë¦¬ ì½”ë“œ`: [ê¹ƒí—ˆë¸Œ ë§í¬](https://github.com/GangEunzzang/stock)

`ê°œë°œ í™˜ê²½`
* Java 17
* Spring boot 3.2.3
* redis 
* docker
* mysql
* jpa
* lombok

<br><br>

## âœ… ë™ì‹œì„± ì´ìŠˆë€?
* ë™ì‹œì— ì—¬ëŸ¬ ê°œì˜ ìŠ¤ë ˆë“œ, í”„ë¡œì„¸ìŠ¤ ë˜ëŠ” ì‘ì—…ì´ ê³µìœ ëœ ìì›ì— ì ‘ê·¼í•˜ê³  ìˆ˜ì •í•˜ëŠ” ê³¼ì •ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë“¤
* ì—¬ëŸ¬ ì‘ì—…ì´ ë™ì‹œì— ì‹¤í–‰ë˜ê³  ë™ì‹œì— ë™ì¼í•œ ìì›ì— ì ‘ê·¼í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ë ¤ê³  í•  ë•Œ ë°œìƒë˜ëŠ” ì´ìŠˆ

<br>

### ğŸ“Œ ë™ì„œì‹± ì´ìŠˆë¡œ ë°œìƒë˜ëŠ” ë¬¸ì œ
* `ê²½ìŸìƒíƒœ(Race Condition)`: ì—¬ëŸ¬ ê°œì˜ ìŠ¤ë ˆë“œë‚˜ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ê³µìœ ëœ ìì›ì— ì ‘ê·¼í•˜ê³  ìˆ˜ì •í•  ë•Œ, ì‹¤í–‰ ìˆœì„œë‚˜ íƒ€ì´ë° ë“±ì— ë”°ë¼ ì˜ˆê¸°ì¹˜ ì•Šì€ ê²°ê³¼ê°€ ë°œìƒ
* `êµì°©ìƒíƒœ(DeadLock)`: ë‘ ê°œ ì´ìƒì˜ ì‘ì—…ì´ ì„œë¡œ ìƒëŒ€ë°©ì´ ê°€ì§„ ìì›ì„ ê¸°ë‹¤ë¦¬ë©´ì„œ ë¬´í•œíˆ ëŒ€ê¸°í•˜ëŠ” ìƒíƒœ
* `ì¼ê´€ì„± ë¬¸ì œ(Consistency Issue)`: ë™ì‹œì— ì—¬ëŸ¬ê°œì˜ ì‘ì—…ì´ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì½ê³  ì“°ëŠ” ê²½ìš°, ë°ì´í„° ì¼ê´€ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ
* `ë³‘ëª© í˜„ìƒ(Bottleneck)`: íŠ¹ì • ìì›ì— ëŒ€í•œ ë™ì‹œ ì ‘ê·¼ì´ ë§ì•„ì ¸ ë³‘ëª©í˜„ìƒ ë°œìƒ

<br><Br>

##  âœ… ì¬ê³ ì‹œìŠ¤í…œ ê¸°ë³¸ ì½”ë“œ

### ğŸ“Œ Stock

```java
@Getter
@NoArgsConstructor
@Entity
public class Stock {
  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private Long id;

  private Long productId;

  private Long quantity;

  @Version
  private Long version;

  public Stock (long productId, long quantity) {
    this.productId = productId;
    this.quantity = quantity;
  }

  public void decrease(Long quantity) {
    if (this.quantity - quantity < 0) {
      throw new RuntimeException("ì¬ê³ ëŠ” 0ê°œë¯¸ë§Œì´ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    this.quantity -= quantity;
  }
}

```

<br>

### ğŸ“Œ StockRepository
```java
public interface StockRepository extends JpaRepository<Stock, Long> {
}
```



<br>

### ğŸ“Œ StockService
```java
@RequiredArgsConstructor
@Service
public class StockService {

    private final StockRepository stockRepository;

    @Transactional
    public void decrease(Long id, Long quantity) {
        Stock stock = stockRepository.findById(id).orElseThrow();
        stock.decrease(quantity);

        stockRepository.saveAndFlush(stock);
    }
}
```
<br>

### ğŸ“Œ StockServiceTest
```java
@SpringBootTest
class StockServiceTest {

    @Autowired
    private StockService stockService;

    @Autowired
    private StockRepository stockRepository;

    @BeforeEach
    public void dataInsert() {
        stockRepository.saveAndFlush(new Stock(1L, 100L));
    }

    @AfterEach
    public void dataDelete() {
        stockRepository.deleteAll();
    }


    @Test
    void ì¬ê³ ê°ì†Œ() throws Exception {
        stockService.decrease(1L, 1L);

        Stock stock = stockRepository.findById(1L).orElseThrow();

        assertThat(99L).isEqualTo(stock.getQuantity());
    }


    @Test
    void ë™ì‹œì—_100ê°œìš”ì²­_ì¬ê³ ê°ì†Œ() throws Exception {
        //given
        int threadCount = 100;
        ExecutorService executorService = Executors.newFixedThreadPool(32);
        CountDownLatch latch = new CountDownLatch(threadCount);

        for (int i = 0; i < threadCount; i++) {
            executorService.submit(() -> {
                try {
                    stockService.decrease(1L, 1L);
                }
                finally {
                    latch.countDown();
                }
            });
        }
        latch.await();

        Stock stock = stockRepository.findById(1L).orElseThrow();
        assertThat(stock.getQuantity()).isZero();
    }

}
```

<br>

ìœ„ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¤‘ `ë™ì‹œì—_100ê°œìš”ì²­_ì¬ê³ ê°ì†Œ` í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼ì…ë‹ˆë‹¤.

![stockestfail.png](..%2F..%2Fassets%2Fimg%2FSpring%2Fstockestfail.png)

`í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ..!` 

ì•„ë˜ ì—¬ëŸ¬ ì˜ˆì œë¥¼ í†µí•´ ë™ì‹œì„± ì´ìŠˆë¥¼ í•´ê²°í•´ ë³´ê² ìŠµë‹ˆë‹¤.

<br><br>


## âœ… ë™ì„œì‹± ì´ìŠˆ í•´ê²°

### ğŸ“Œ Java - synchronized

```java
public synchronized void decrease(Long id, Long quantity) {
  Stock stock = stockRepository.findById(id).orElseThrow();
  stock.decrease(quantity);

  stockRepository.saveAndFlush(stock);
}
```

* ë©”ì„œë“œì— ê³ ìœ ë½ì„ ê±¸ì–´ í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ í•´ì¤€ë‹¤.
* `ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ìŠ¤ë ˆë“œê°„ ë°ì´í„° ë™ê¸°í™”`ë¥¼ ì‹œì¼œì£¼ê¸° ìœ„í•´ ìë°”ì—ì„œ ì œê³µí•˜ëŠ” í‚¤ì›Œë“œ

#### ë¬¸ì œì 
* `synchronized`ëŠ” í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ ì•ˆì—ì„œë§Œ ë³´ì¥ì´ ëœë‹¤
* ì„œë²„ê°€ 1ëŒ€ì¼ ë•ŒëŠ” ì •ìƒ ë™ì‘í•˜ì§€ë§Œ ì„œë²„ê°€ 2ëŒ€ ì´ìƒì¼ ê²½ìš° ë™ê¸°í™”ê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
* @Transactional ê³¼ ë™ì‹œì— ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
  -> ì‹¤ì œ `commit` ë‚˜ê°€ëŠ” ì‹œì ë³´ë‹¤ ë¹ ë¥´ê²Œ ë‹¤ìŒ ìŠ¤ë ˆë“œê°€ ë©”ì„œë“œ ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì— ë°ì´í‹° ë¶ˆì¼ì¹˜ ë¬¸ì œ ë°œìƒ

<br>


### ğŸ“Œ Database(Mysql) - Pessimistic Lock(ë¹„ê´€ì  ë½)
```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("select s from Stock s where s.id = :id")
Stock findByIdWithPessimisticLock(Long id);
}
```

* ì‹¤ì œ ì¿¼ë¦¬ì— Lockì„ ê±¸ì–´ ì •í•©ì„±ì„ ë§ì¶”ëŠ” ë°©ë²•
* `exclusive lock(ë² íƒ€ì  ì ê¸ˆ)`ì„ ê±¸ê²Œë˜ë©´ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œëŠ” lockì´ í•´ì œë˜ê¸° ì „ì— ë°ì´í„°ë¥¼ ê°€ì ¸ê°ˆ ìˆ˜ ì—†ìŒ
* lockì˜ ë²”ìœ„ë¥¼ ìµœì†Œí•œ í•´ì•¼í•œë‹¤.

#### ë¬¸ì œì 
* ë°ë“œë½ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ
* ë™ì‹œ ì²˜ë¦¬ ì„±ëŠ¥ ì €í•˜ ë°œìƒ

<br>


### ğŸ“Œ Database(Mysql) - Optimistic Lock(ë‚™ê´€ì  ë½)
```java

// Stock í´ë˜ìŠ¤ì— ì¶”ê°€
@Version
private Long version; 

// Repository
@Lock(LockModeType.OPTIMISTIC)
@Query("select s from Stock s where s.id = :id")
Stock findByIdWithOptimisticLock(Long id);
}

```

* Entityì— version ì»¬ëŸ¼ ì¶”ê°€ ë° ì¶©ëŒ ë°œìƒì‹œ ì²˜ë¦¬ ë¡œì§ì„ ì§ì ‘ êµ¬í˜„í•´ì£¼ëŠ” ë°©ì‹
* ì‹¤ì œë¡œ Lockì„ ê±¸ì§€ì•Šê³  version ê°’ì„ ì´ìš©í•˜ì—¬ ì •í•©ì„±ì„ ë§ì¶”ëŠ” ë°©ë²•
* ì¶©ëŒì´ ë‚˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê°€ì •í•˜ì—, ë³„ë„ì˜ ë½ì„ ì¡ì§€ ì•Šìœ¼ë¯€ë¡œ ë¹„ê´€ì  ë½ë³´ë‹¨ ì„±ëŠ¥ì´ ì¢‹ìŒ

#### ê³¼ì •
1. Server1ì´ version1 ì„ì„ ì¡°ê±´ì ˆì— ëª…ì‹œí•˜ë©´ì„œ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¼
2. version1 ê°’ì´ ì—…ë°ì´íŠ¸ ë˜ì–´ version2ê°€ ë¨
3. server2ê°€ version1ë¡œ ì—…ë°ì´íŠ¸ë¥¼ ì‹œë„í•˜ë©´ ë²„ì „ì´ ë§ì§€ ì•Šì•„ ì‹¤íŒ¨í•¨

#### ë¬¸ì œì 
* ì—…ë°ì´íŠ¸ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ, ì¬ì‹œë„ ë¡œì§ì„ ê°œë°œìê°€ êµ¬í˜„í•´ ì¤˜ì•¼í•¨
* ì¶©ëŒì´ ë¹ˆë²ˆí•˜ê²Œ ì¼ì–´ë‚˜ë©´ ì˜¤íˆë ¤ ì„±ëŠ¥ì´ ì•ˆì¢‹ìŒ

<br>


### ğŸ“Œ Database(Mysql) - Named Lock

```java
// Repository
@Query(value = "select get_lock(:key, 3000)", nativeQuery = true)
void getLock(String key);

@Query(value = "select release_lock(:key)", nativeQuery = true)
void releaseLock(String key);


// service
@Transactional
public void decrease(Long id, Long quantity) {
  try {
    lockRepository.getLock(id.toString());
    stockService.decrease(id, quantity);
  } finally {
    lockRepository.releaseLock(id.toString());
  }
}
```

* ì´ë¦„ì„ ê°€ì§„ `metadata Lock`ì´ë‹¤.
* ë½ì„ íšë“ í›„, í•´ì§€ë  ë•Œ ê¹Œì§€ ë‹¤ë¥¸ ì„¸ì…˜ì€ ì´ ë½ì„ íšë“í•  ìˆ˜ ì—†ìŒ
* íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë  ë•Œ ë½ì´ ìë™ìœ¼ë¡œ í•´ì§€ë˜ê¸° ì•Šê¸° ë•Œë¬¸ì—, ë³„ë„ë¡œ í•´ì£¼í•´ì£¼ê±°ë‚˜ ì„ ì ì‹œê°„ì´ ëë‚˜ì•¼ í•´ì§€ë¨
* Mysqlì—ì„œëŠ” `getLock()` ë½ íšë“, `releaseLock()` ë½ í•´ì œ ëª…ë ¹ì–´ ì…ë‹ˆë‹¤.
* `Pessimistic Lock` ì€ time outì„ êµ¬í˜„í•˜ê¸° í˜ë“¤ì§€ë§Œ, `Named Lock`ì€ ì†ì‰½ê²Œ ëª…ì‹œí•  ìˆ˜ ìˆìŒ

#### ë¬¸ì œì 
* ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì»¤ë„¥ì…˜í’€ì´ ë¶€ì¡±í•´ì§ˆ ìˆ˜ ìˆê¸°ë•Œë¬¸ì— DataSource ë¶„ë¦¬ í•´ì•¼í•œë‹¤.

<br>


### ğŸ“Œ Redis - Lettuce



ì¢…ë£Œ ìš”ì²­ì‹œ ì•„ë˜ì˜ `shutDownGracefully` ë©”ì„œë“œê°€ í˜¸ì¶œë©ë‹ˆë‹¤. 
```java
public void shutDownGracefully(GracefulShutdownCallback callback) {
        if (this.gracefulShutdown == null) {
            callback.shutdownComplete(GracefulShutdownResult.IMMEDIATE);
        } else {
            this.gracefulShutdown.shutDownGracefully(callback);
        }
    }
```



ê·¸ë¦¬ê³  `GracefulShutdown`ì˜ `shutDownGracefully` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
```java
void shutDownGracefully(GracefulShutdownCallback callback) {
        logger.info("Commencing graceful shutdown. Waiting for active requests to complete");
        (new Thread(() -> {
            this.doShutdown(callback);
        }, "tomcat-shutdown")).start();
    }

    private void doShutdown(GracefulShutdownCallback callback) {
        List<Connector> connectors = this.getConnectors();
        connectors.forEach(this::close);

        try {
            Container[] var3 = this.tomcat.getEngine().findChildren();
            int var4 = var3.length;

            for(int var5 = 0; var5 < var4; ++var5) {
                Container host = var3[var5];
                Container[] var7 = host.findChildren();
                int var8 = var7.length;

                for(int var9 = 0; var9 < var8; ++var9) {
                    Container context = var7[var9];

                    while(this.isActive(context)) {
                        if (this.aborted) {
                            logger.info("Graceful shutdown aborted with one or more requests still active");
                            callback.shutdownComplete(GracefulShutdownResult.REQUESTS_ACTIVE);
                            return;
                        }

                        Thread.sleep(50L);
                    }
                }
            }
        } catch (InterruptedException var11) {
            Thread.currentThread().interrupt();
        }

        logger.info("Graceful shutdown complete");
        callback.shutdownComplete(GracefulShutdownResult.IDLE);
    }
```

ë¨¼ì €, `doShutdown ë©”ì„œë“œì—ì„œ connectorë“¤ì„ ë‹«ìŒìœ¼ë¡œì¨ ìƒˆë¡œìš´ ìš”ì²­ë“¤ì„ ë°›ì§€ ì•Šë„ë¡` í•©ë‹ˆë‹¤.

`doShutdown ë©”ì„œë“œ ë‚´ë¶€ whileë¬¸ì—ì„œ isActiveë¼ëŠ” ë©”ì„œë“œë¥¼ í†µí•´ í˜„ì¬ ì²˜ë¦¬ì¤‘ì¸ ìš”ì²­ì´ ìˆëŠ”ì§€ í™•ì¸`í•˜ê³    
ì¡´ì¬í•˜ë©´ ë£¨í”„ì—ì„œ 50msì”© ê¸°ë‹¤ë¦¬ë©´ì„œ ì§€ì†ì ìœ¼ë¡œ ì™„ë£Œë˜ì§€ ì•Šì€ ìš”ì²­ì— ëŒ€í•œ í™•ì¸ì„ í•©ë‹ˆë‹¤.



